name: Smart Fetch & Compare

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'æºæ–‡ä»¶URLï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      target_path:
        description: 'ä¿å­˜è·¯å¾„ï¼ˆé»˜è®¤worker.jsï¼‰'
        required: false
        default: 'worker.js'
  schedule:
    - cron: '0 8 * * *'
  push:
    paths:
      - '.github/workflows/main.yml'
      - 'fetch-config.json'

jobs:
  smart-fetch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: 1ï¸âƒ£ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    - name: 2ï¸âƒ£ åŠ è½½é…ç½®
      id: config
      run: |
        SOURCE_URL="${{ github.event.inputs.source_url || secrets.FETCH_SOURCE_URL || '' }}"
        TARGET_PATH="${{ github.event.inputs.target_path || 'worker.js' }}"
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæä¾›æºæ–‡ä»¶URLã€‚è¯·åœ¨Secretsä¸­è®¾ç½®FETCH_SOURCE_URLï¼Œæˆ–åœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¾“å…¥ã€‚"
          exit 1
        fi
        echo "source_url=$SOURCE_URL" >> $GITHUB_OUTPUT
        echo "target_path=$TARGET_PATH" >> $GITHUB_OUTPUT
    - name: 3ï¸âƒ£ æ‹‰å–å¹¶å¯¹æ¯”æ–‡ä»¶
      id: process
      run: |
        set -e
        SOURCE_URL="${{ steps.config.outputs.source_url }}"
        TARGET_PATH="${{ steps.config.outputs.target_path }}"
        TEMP_FILE="new_content.tmp"
        # æ‹‰å–æ–‡ä»¶
        echo "ğŸ“¥ æ­£åœ¨ä» $SOURCE_URL æ‹‰å–æ–‡ä»¶..."
        if ! curl -s -L -o "$TEMP_FILE" "$SOURCE_URL"; then
          echo "âŒ æ‹‰å–å¤±è´¥"
          exit 1
        fi
        # è®¡ç®—å“ˆå¸Œ
        NEW_HASH=$(sha256sum "$TEMP_FILE" | cut -d' ' -f1)
        echo "ğŸ” æ–°æ–‡ä»¶å“ˆå¸Œ: $NEW_HASH"
        # å¯¹æ¯”é€»è¾‘
        if [ -f "$TARGET_PATH" ]; then
          OLD_HASH=$(sha256sum "$TARGET_PATH" | cut -d' ' -f1)
          echo "ğŸ” æ—§æ–‡ä»¶å“ˆå¸Œ: $OLD_HASH"
          if [ "$NEW_HASH" = "$OLD_HASH" ]; then
            echo "âœ… å†…å®¹ç›¸åŒï¼Œæ— éœ€æ›´æ–°"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            rm "$TEMP_FILE"
            exit 0
          else
            echo "ğŸ”„ å†…å®¹æœ‰å˜åŒ–ï¼Œéœ€è¦æ›´æ–°"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "ğŸ“„ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        # ä¿å­˜æ–‡ä»¶
        mkdir -p "$(dirname "$TARGET_PATH")"
        mv "$TEMP_FILE" "$TARGET_PATH"
        echo "file_hash=$NEW_HASH" >> $GITHUB_OUTPUT
    - name: 4ï¸âƒ£ æäº¤å˜æ›´ï¼ˆä»…å½“æœ‰å˜åŒ–æ—¶ï¼‰
      if: steps.process.outputs.has_changes == 'true'
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions@users.noreply.github.com"
        git add "${{ steps.config.outputs.target_path }}"
        git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ–‡ä»¶ [${{ steps.process.outputs.file_hash }}]"
        git push
        echo "ğŸ‰ å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
