name: Auto Fetch File to Repository

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      file_url:
        description: 'è¦æ‹‰å–çš„æ–‡ä»¶URLï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      file_name:
        description: 'ä¿å­˜çš„æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'worker.js'
  
  # å®šæ—¶è§¦å‘ï¼ˆå¯é€‰ï¼Œæ¯å¤©UTC 0ç‚¹æ‰§è¡Œï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # æ¨é€ä»£ç æ—¶è§¦å‘
  push:
    branches: [ main ]

jobs:
  fetch-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_PAT }}
    
    - name: ç¡®å®šæ–‡ä»¶URLå’Œåç§°
      id: config
      run: |
        # å¦‚æœæ‰‹åŠ¨è§¦å‘æ—¶æœ‰è¾“å…¥ï¼Œä½¿ç”¨è¾“å…¥çš„å€¼
        if [ -n "${{ github.event.inputs.file_url }}" ]; then
          FILE_URL="${{ github.event.inputs.file_url }}"
          FILE_NAME="${{ github.event.inputs.file_name }}"
        else
          # å¦åˆ™ä½¿ç”¨ä»“åº“Secretsä¸­çš„é…ç½®
          FILE_URL="${{ secrets.FETCH_FILE_URL }}"
          FILE_NAME="${{ secrets.FETCH_FILE_NAME }}"
        fi
        
        # è®¾ç½®é»˜è®¤å€¼
        if [ -z "$FILE_NAME" ]; then
          FILE_NAME="worker.js"
        fi
        
        echo "FILE_URL=${FILE_URL}" >> $GITHUB_OUTPUT
        echo "FILE_NAME=${FILE_NAME}" >> $GITHUB_OUTPUT
        echo "FILE_PATH=${FILE_NAME}" >> $GITHUB_OUTPUT
    
    - name: ä»URLæ‹‰å–æ–‡ä»¶
      if: steps.config.outputs.FILE_URL != ''
      run: |
        echo "æ­£åœ¨ä» ${{ steps.config.outputs.FILE_URL }} æ‹‰å–æ–‡ä»¶..."
        echo "ä¿å­˜ä¸º: ${{ steps.config.outputs.FILE_PATH }}"
        
        # ä½¿ç”¨curlä¸‹è½½æ–‡ä»¶
        curl -L -o "${{ steps.config.outputs.FILE_PATH }}" "${{ steps.config.outputs.FILE_URL }}"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ -f "${{ steps.config.outputs.FILE_PATH }}" ]; then
          echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < "${{ steps.config.outputs.FILE_PATH }}") bytes"
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -20 "${{ steps.config.outputs.FILE_PATH }}"
        else
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
    
    - name: æ£€æŸ¥æ–‡ä»¶å·®å¼‚
      id: diff
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet "${{ steps.config.outputs.FILE_PATH }}" 2>/dev/null; then
          echo "æ²¡æœ‰å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "å‘ç°å˜æ›´"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå˜æ›´å†…å®¹
          echo "=== å˜æ›´å†…å®¹ ==="
          git diff "${{ steps.config.outputs.FILE_PATH }}" || echo "è¿™æ˜¯æ–°æ–‡ä»¶"
        fi
    
    - name: æäº¤å˜æ›´
      if: steps.diff.outputs.has_changes == 'true'
      run: |
        # æ·»åŠ å¹¶æäº¤æ–‡ä»¶
        git add "${{ steps.config.outputs.FILE_PATH }}"
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ–‡ä»¶: ${{ steps.config.outputs.FILE_NAME }} [$(date +'%Y-%m-%d %H:%M:%S')]"
        git push origin main
        
        echo "âœ… å˜æ›´å·²æäº¤åˆ°ä»“åº“"
    
    - name: æ— å˜æ›´é€šçŸ¥
      if: steps.diff.outputs.has_changes == 'false'
      run: |
        echo "âœ… æ–‡ä»¶æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
